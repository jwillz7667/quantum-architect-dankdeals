# Admin Product Form vs Database Schema Audit

**Date**: 2025-10-02
**Status**: ‚ö†Ô∏è Form Schema Issues Found

## Summary

Audited the admin product creation form against the database schema. Found that **the form validation is too strict** - it expects UUID format for variant IDs, but the database intentionally uses TEXT to support custom identifiers like `pv_pf_eighth`.

---

## ‚úÖ Products Table - VALID

All form fields correctly map to database columns:

| Form Field      | DB Column       | Type          | Status                               |
| --------------- | --------------- | ------------- | ------------------------------------ |
| id              | id              | uuid          | ‚úÖ Match                             |
| name            | name            | text          | ‚úÖ Match                             |
| description     | description     | text          | ‚úÖ Match                             |
| category        | category        | text          | ‚úÖ Match                             |
| price           | price           | numeric(10,2) | ‚úÖ Match                             |
| image_url       | image_url       | text          | ‚úÖ Match                             |
| gallery_urls    | gallery_urls    | text[]        | ‚úÖ Match (parsed from gallery_input) |
| thc_content     | thc_content     | numeric(5,2)  | ‚úÖ Match                             |
| cbd_content     | cbd_content     | numeric(5,2)  | ‚úÖ Match                             |
| strain_type     | strain_type     | text          | ‚úÖ Match                             |
| effects         | effects         | text[]        | ‚úÖ Match (parsed from effects_input) |
| flavors         | flavors         | text[]        | ‚úÖ Match (parsed from flavors_input) |
| stock_quantity  | stock_quantity  | integer       | ‚úÖ Match                             |
| weight_grams    | weight_grams    | numeric(8,2)  | ‚úÖ Match                             |
| is_active       | is_active       | boolean       | ‚úÖ Match                             |
| is_featured     | is_featured     | boolean       | ‚úÖ Match                             |
| lab_tested      | lab_tested      | boolean       | ‚úÖ Match                             |
| lab_results_url | lab_results_url | text          | ‚úÖ Match                             |
| ‚Äî               | slug            | text          | ‚ÑπÔ∏è Auto-generated by trigger         |
| ‚Äî               | search_vector   | tsvector      | ‚ÑπÔ∏è Auto-generated by trigger         |
| ‚Äî               | created_at      | timestamptz   | ‚ÑπÔ∏è Auto-set by database              |
| ‚Äî               | updated_at      | timestamptz   | ‚ÑπÔ∏è Auto-set by database              |

---

## ‚ö†Ô∏è Product Variants Table - FORM ISSUES FOUND

### Issue #1: Form Validation Too Strict for Variant IDs

**Problem**: Form expects UUID format, but database uses custom TEXT identifiers

**Current Database Data** (16 existing variants):

```
pv_pf_eighth, pv_rs_eighth, pv_rz_eighth, pv_wc_eighth,
pv_pf_quarter, pv_rs_quarter, pv_rz_quarter, pv_wc_quarter,
pv_pf_half, pv_rs_half, pv_rz_half, pv_wc_half,
pv_pf_ounce, pv_rs_ounce, pv_rz_ounce, pv_wc_ounce
```

**Form Schema** (AdminProductForm.tsx line 51):

```typescript
const variantSchema = z.object({
  id: z.string().uuid().optional(),  // ‚ùå TOO STRICT - rejects custom IDs
  ...
});
```

**Database Schema**:

```sql
CREATE TABLE "product_variants" (
    "id" "text" NOT NULL,  -- ‚úÖ CORRECT - allows custom identifiers
    ...
);
```

**Why TEXT is Correct**:

- Allows semantic IDs like `pv_productname_size`
- Better for debugging and logs
- More flexible than UUIDs
- Can be auto-generated or manually set

**Fix Required**: ‚ö†Ô∏è **Change form validation from `.uuid()` to `.string()`**

---

### Issue #2: Price Type Mismatch

**Problem**: Form allows decimal prices but database only accepts integers

| Form Field | Form Type                | DB Column | DB Type | Impact                |
| ---------- | ------------------------ | --------- | ------- | --------------------- |
| price      | number (allows decimals) | price     | integer | ‚ö†Ô∏è Decimals truncated |

**Form Code** (AdminProductForm.tsx line 53):

```typescript
const variantSchema = z.object({
  price: z.preprocess(parseRequiredNumber, z.number().nonnegative()),  // Allows decimals
  ...
});
```

**Database Schema**:

```sql
CREATE TABLE "product_variants" (
    "price" integer NOT NULL,  -- Integer only, no decimals
    ...
);
```

**Question**: Should variants support decimal prices?

**Options**:

1. **Keep INTEGER** - Force whole dollar prices for variants (e.g., $10, $25)
2. **Change to NUMERIC** - Support decimal prices (e.g., $10.50, $24.99)

**Recommendation**: Change database to NUMERIC(10,2) because:

- Product base price is already NUMERIC(10,2)
- Consistency between product and variant pricing
- More flexible for future pricing strategies
- Cannabis products often have prices like $12.50, $35.99

---

### Other Variant Fields - Valid

| Form Field      | DB Column       | Type         | Status             |
| --------------- | --------------- | ------------ | ------------------ |
| name            | name            | text         | ‚úÖ Match           |
| weight_grams    | weight_grams    | numeric(8,2) | ‚úÖ Match           |
| inventory_count | inventory_count | integer      | ‚úÖ Match           |
| is_active       | is_active       | boolean      | ‚úÖ Match           |
| ‚Äî               | product_id      | uuid         | ‚ÑπÔ∏è Set by function |
| ‚Äî               | created_at      | timestamptz  | ‚ÑπÔ∏è Auto-set        |
| ‚Äî               | updated_at      | timestamptz  | ‚ÑπÔ∏è Auto-set        |

---

## üîß Required Fixes

### Fix #1: Update Form Validation for Variant IDs

**File**: `src/pages/admin/components/AdminProductForm.tsx`

**Change** (line 51):

```typescript
// ‚ùå Before - Too strict
const variantSchema = z.object({
  id: z.string().uuid().optional(),
  ...
});

// ‚úÖ After - Accepts any text ID
const variantSchema = z.object({
  id: z.string().optional(),
  ...
});
```

**Reason**: Database uses custom TEXT identifiers, not UUIDs

---

### Fix #2: Change Variant Price to NUMERIC (Optional but Recommended)

**Migration**:

```sql
ALTER TABLE product_variants
  ALTER COLUMN price TYPE numeric(10,2) USING price::numeric(10,2);
```

**Reason**:

- Consistency with product.price (NUMERIC)
- Support decimal prices without truncation
- More flexible pricing

**Risk**: Low - INTEGER can safely convert to NUMERIC

---

## Risk Assessment

**Issue #1 (Form validation too strict)**:

- **Risk**: HIGH - Form cannot edit existing variants
- **Breaking**: Yes - Cannot save products with custom variant IDs
- **User Impact**: Admin form unusable for existing products

**Issue #2 (Price type)**:

- **Risk**: MEDIUM - Decimal prices get truncated
- **Breaking**: No - Works but loses precision
- **Data Loss**: Possible if variants ever had decimal prices entered

---

## Testing Required After Fixes

1. ‚úÖ Edit existing product with variants (e.g., `pv_pf_eighth`)
2. ‚úÖ Create new variant with auto-generated ID
3. ‚úÖ Create new variant with custom ID
4. ‚úÖ Test decimal price input (e.g., $12.99)
5. ‚úÖ Verify price saves and displays correctly

---

## Files to Fix

1. **src/pages/admin/components/AdminProductForm.tsx** - Remove `.uuid()` validation
2. **supabase/migrations/[new]\_change_variant_price_to_numeric.sql** - Change price type (optional)

---

## Conclusion

**Database schema is correct.** The form validation is too restrictive.

The use of TEXT for variant IDs is a good design choice that allows:

- Semantic identifiers (`pv_productname_size`)
- Manual ID assignment for consistency
- Better debugging and logging
- More flexibility than auto-generated UUIDs

**Action**: Fix the form, not the database.
